#admin_header
<div class="am-cf admin-main">
#admin_sidebar
<div class="admin-content">

    <div class="am-cf am-padding">
      <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">合作公司维护</strong> / <small>查询</small></div>
    </div>

    <div class="am-g">
    <form id="searchForm" action="${rc.contextPath}/company/listCompany.html">
     <input type="hidden" id="pageNo" name="pageNo"/>
      <div class="am-u-sm-12 am-u-md-6">
        <div class="am-btn-toolbar">
          <div class="am-btn-group am-btn-group-xs">
            <button type="button" id="addBtn" class="am-btn am-btn-default"><span class="am-icon-plus"></span> 新增</button>
            <!-- <button type="button" class="am-btn am-btn-default"><span class="am-icon-trash-o"></span> 删除</button> -->
          </div>
        </div>
      </div>
      <div class="am-u-sm-12 am-u-md-3 am-u-end">
        <div class="am-input-group am-input-group-sm">
          <input type="text" name="companyName" value="$!{company.companyName}" class="am-form-field">
          <span class="am-input-group-btn">
            <button class="am-btn am-btn-default" id="searchBtn" type="button">搜索</button>
          </span>
        </div>
      </div>
      </form>
    </div>

    <div class="am-g">
      <div class="am-u-sm-12">
        <form class="am-form">
          <table class="am-table am-table-striped am-table-hover table-main">
            <thead>
              <tr>
                <th class="table-check"><input type="checkbox" /></th>
                <th class="table-id"></th>
                <th class="table-title">公司名称</th>
                <th class="table-title">logo</th>
                <th class="table-title">地址</th>
                <th class="table-title">电话</th>
                <th class="table-title">联系人</th>
                <th class="table-title">联系人电话</th>
                
                <th class="table-set">操作</th>
              </tr>
          </thead>
          <tbody>
          	#foreach($company in $companyList)
            <tr>
              <td><input type="checkbox" value="$!{company.companyId}"/></td>
              <td></td>
              <td>$!{company.companyName}</td>
              <td>
              	<button class="am-btn am-btn-default am-btn-xs am-text-primary"
 	     			data-am-popover="{theme: 'primary',content: '<img style=\'width:200px;\' src=\'$!{rc.contextPath}$!{company.companyLogo}\'/>', trigger: 'hover focus'}">
 					预览
				</button>
              </td>
              <td>$!{company.address}</td>
              <td>$!{company.phone}</td>
              <td>$!{company.liaisonName}</td>
              <td>$!{company.liaisonPhone}</td>
              <td>
                <div class="am-btn-toolbar">
                  <div class="am-btn-group am-btn-group-xs">
                    ##<button type="button" class="am-btn am-btn-default am-btn-xs am-text-secondary" onclick="location='${rc.contextPath}/card/editCardSample.html?projectId=${cardSample.projectId}'"><span class="am-icon-pencil-square-o"></span> 编辑</button>
                    <button type="button" class="am-btn am-btn-default am-btn-xs am-text-warning" onclick="javascript:assignActivity('$!{company.companyId}')"><span class="am-icon-pencil-square-o"></span> 管理公司活动</button>
                    <button type="button" class="am-btn am-btn-default am-btn-xs am-text-danger am-hide-sm-only" onclick="javascript:deleteItem('$!{company.companyId}')"><span class="am-icon-trash-o"></span> 删除</button>
                  </div>
                </div>
              </td>
            </tr>
            #end
          </tbody>
        </table>
          <div class="am-cf">
  共 ${page.totalCount} 条记录
  <div class="am-fr">
    <ul class="am-pagination">
      <li #if(${page.pageNo}=='1') class="am-disabled" #end><a href="javascript:query(1)">«</a></li>
      #if(${page.totalPages}>0)
      #foreach($foo in [1..${page.totalPages}])
      <li #if($foo==$page.pageNo) class="am-active" #end><a href="javascript:query($foo)">$foo</a></li>
      #end
      #else
      <li class="am-active"><a href="javascript:query(1)">1</a></li>
      #end
      
      <li #if(${page.pageNo}==${page.totalPages}) class="am-disabled" #end><a href="javascript:query(${page.totalPages})">»</a></li>
    </ul>
  </div>
</div>
          <hr />
          <p>注：.....</p>
        </form>
      </div>

    </div>
  </div>
 </div>


<div class="am-modal am-modal-confirm am-margin" tabindex="-1" id="company-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">分配公司活动</div>
    <div class="am-modal-bd" id="companyActivity">
      	<form action="" class = "am-form">
      		<input type="hidden" name="companyId" id="companyId"/>
      		<div class="am-g am-margin-top">
		<div class="am-g">
			<a href="javascript:addActivityBoxes()" id="addActivity" class="c1">+增加公司活动</a>		
		</div>
            <div class="am-u-sm-4 am-u-md-4 am-text-center">
           		活动名称
            </div>
            <div class="am-u-sm-8 am-u-md-7 am-u-end am-text-center">
            	活动内容
            </div>
          </div>
          <div id="boxes">
          
   		  </div> 		
      	</form>
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
    </div>
  </div>
</div>

 #admin_sidebar_sm
 #confirm
 #admin_footer
 
 
<script type="text/javascript">
 var count=1;
 var i = 2;
$(function(){
	$("#addBtn").click(function(){
		window.location.href='${rc.contextPath}/company/addCompany.html';
	});
	$("#searchBtn").click(function(){		
		query();
	});
	
	$("#boxes").delegate(".del","click",function(){
		$(this).parent().parent().parent().remove();
		i++;
	})
});


function query(pageNo){
	if(pageNo){
		$("#pageNo").val(pageNo);
	}
	$("#searchForm").submit();
	
}

function deleteItem(companyId){
	if(companyId){
		$('#my-confirm').modal({
	        relatedTarget: this,
	        onConfirm: function(options) {
	          window.location.href='${rc.contextPath}/company/deleteCompany.html?companyId='+ companyId;
								},
								// closeOnConfirm: false,
								onCancel : function() {

								}
							});
		}
	}

/**
 * 分配公司活动
 */
function assignActivity(companyId){
	i=2;
	count=1;
	$("#companyId").val(companyId);
	$("#boxes").empty();
	loadExistingActivity(companyId);
	$('#company-confirm').modal({
        relatedTarget: this,
        onConfirm: function(options) {
        	submitForm(companyId);
        },
      //  closeViaDimmer: false,
        width: 1000,
        // closeOnConfirm: false,
        onCancel: function() {
        	i=2;
        	count=1;
        }
      });
}

/**
 * 获取已存的公司活动
 */
function loadExistingActivity(companyId){
	var param = "companyId="+companyId;
	$.ajax({
		type : 'post',
        url : '${rc.contextPath}/company/ajax/getExistingActivity.json',
		data : param,
        dataType : 'json',  
        success : function(data){
			if(data.success){
				if(data.data.length>0){
					for(var i=0;i<data.data.length;i++){
						createActivityBoxes(data.data[i]);
					}
				}else{
					createActivityBoxes(null);
				}
			}else{
				alert("获取分配公司活动操作失败！");
			}
        },  
        error : function(data,textstatus){
			alert("获取分配公司活动操作失败！");
        }  
    });
}


/**
 * 新增公司内容
 */

function createActivityBoxes(activity){
	var activityHtml=	
    '<div class="unit"><div class="am-g am-margin-top ">'
    +'<div class="am-u-sm-4 am-u-md-4">'
    +'<p><input type="text" name="activityName" class="am-form-field am-radius"'
    if(activity){
    	activityHtml=activityHtml+' value="'+activity.activityName+'" ';
    }
	activityHtml=activityHtml+' placeholder="活动名称" maxlength="50"/></p>'
    +'</div>'
    +'<div class="am-u-sm-7 am-u-md-7">'
    +'<p><input type="text" name="activityContent" class="am-form-field am-radius"'
    if(activity){
    	activityHtml=activityHtml+' value="'+activity.activityContent+'" ';
    }
    activityHtml=activityHtml+' placeholder="活动内容"  maxlength="100"/></p>'
    +'</div>'
    +'<div class="am-u-sm-1 am-u-md-1 am-u-end ">'
    +'<a class="del am-margin-top-sm" href="javascript:;"></a>'
    +'</div>'
    +'</div></div>'
	$(activityHtml).appendTo("#boxes");
    count++;
}

/**
 * 新增项目录入
 */
function addActivityBoxes(){
	createActivityBoxes(null);
}

/**
 * 提交表单活动
 */
 function submitForm(companyId){
		var isValid=true;
		var param='[';
		$(".unit").each(function(){
			var $activityName=$(this).find("input[name='activityName']");
			var $activityContent=$(this).find("input[name='activityContent']");
			if(!$activityName.val()){
				$activityName.focus();
				alert("活动名称不可为空");
				isValid=false;
				return false;
			}
			if(!$activityContent.val()){
				$activityContent.focus();
				alert("活动内容不可为空");
				isValid=false;
				return false;
			}
			
			param = param+'{"companyId":"'+companyId+'","activityName":"'+$activityName.val()+'","activityContent":"'+$activityContent.val()+'"';
			if(i==count){
				param=param+'}';
			}else{
				param=param+'},';
			}
			i++;
		})
		param=param+']';
		count=0;
		i=0;
		if(!isValid){
			return;
		}
		$.ajax({
			type : 'post',
	        url : '${rc.contextPath}/company/ajax/saveCompanyActivity.json',
			data : param,
	        dataType : 'json', 
	        contentType : 'application/json;charset=utf-8',
	        success : function(data){
				if(data.success){
					window.location.href="${rc.contextPath}/company/listCompany.html";
				}else{
					alert("保存失败");
				}
	        },  
	        error : function(data,textstatus){
				alert("保存失败");
	        }  
	    });
	}

</script>