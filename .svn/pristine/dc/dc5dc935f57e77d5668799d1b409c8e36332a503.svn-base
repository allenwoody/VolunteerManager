#admin_header
<div class="am-cf admin-main">
#admin_sidebar
<div class="admin-content">

    <div class="am-cf am-padding">
      <div class="am-fl am-cf"><strong class="am-text-primary am-text-lg">卡信息库</strong> / <small>查询</small></div>
    </div>

    <div class="am-g">
    <form id="searchForm" action="${rc.contextPath}/card/listCardInfo.html" method="post" enctype="multipart/form-data">
     <input type="hidden" id="pageNo" name="pageNo"/>
      <div class="am-u-sm-12">
        <div class="am-btn-toolbar">
          <div class="am-btn-group am-btn-group-xs">
            <button type="button" id="addBtn" class="am-btn am-btn-default"><span class="am-icon-plus"></span> 新增</button>
            <button type="button" id="submitAuditBtn" class="am-btn am-btn-default"><span class="am-icon-reply-all"></span> 批量提交审核</button>
          </div>
          <div class="am-btn-group am-btn-group-xs">
           <div class="am-form-group am-form-file">
			  <button type="button" class="am-btn am-btn-default am-btn-xs">
			    <i class="am-icon-cloud-upload"></i> 需要导入的EXCEL表</button>
			  <input type="file" id="incFile" name="incFile" multiple>
			</div>
          </div>
        </div>
      </div>
      
      <div class="am-u-sm-6 am-u-md-3">
        <div class="am-input-group am-input-group-sm">
  			<span class="am-input-group-label">所属客户</span>
  			<input type="text" name="name" value="$!{model.name}" class="am-form-field" placeholder="所属客户">
		</div>
      </div>
      <div class="am-u-sm-6 am-u-md-3">
        <div class="am-input-group am-input-group-sm">
  			<span class="am-input-group-label">卡号</span>
  			<input type="text" name="cardNo" value="$!{model.cardNo}" class="am-form-field" placeholder="卡号">
		</div>
      </div>
      <div class="am-u-sm-6 am-u-md-3">
        <div class="am-input-group am-input-group-sm">
  			<span class="am-input-group-label">保单号</span>
  			<input type="text" name="policyNo" value="$!{model.policyNo}" class="am-form-field" placeholder="保单号">
		</div>
      </div>
      <div class="am-u-sm-12 am-u-md-2 am-u-end">
        <div class="am-input-group am-input-group-sm">
          <span class="am-input-group-btn">
            <button class="am-btn am-btn-default" id="searchBtn" type="button">搜索</button>
          </span>
        </div>
      </div>
      </form>
    </div>

    <div class="am-g">
      <div class="am-u-sm-12">
        <form class="am-form">
          <table class="am-table am-table-striped am-table-hover table-main">
            <thead>
              <tr>
                <th class="table-check"><input id="main-control-checkbox" type="checkbox" /></th>
                <th class="table-title">项目名称</th>
                <th class="table-title">所属客户</th>
                <th class="table-title">保单号/分单号</th>
                <th class="table-title">卡号</th>
                <th class="table-date">有效期</th>
                <th class="table-title">卡状态</th>
                <th class="table-title">审批状态</th>
                <th class="table-set">操作</th>
              </tr>
          </thead>
          <tbody>
          	#foreach($card in $cardMap.keySet())
            <tr>
              <td>#if(${card.auditState}==1) <input type="checkbox" name="cardId" value="$!{card.cardId}"/> #end</td>
              <td>$!{card.projectName}</td>
              <td>$!{cardMap.get($card)}</td>
              <td>$!{card.policyNo}</td>
              <td>$!{card.cardNo}</td>
              <td>$!{card.startDate} 至 $!{card.finishDate}</td>
              <td>$!cardStateMap.get($!{card.cardState})</td>
              <td>$!auditStateMap.get($!{card.auditState})</td>
              <td>
                <div class="am-btn-toolbar">
                  <div class="am-btn-group am-btn-group-xs">
                  	#if($!{card.auditState}==1)
                    <button type="button" class="am-btn am-btn-default am-btn-xs am-text-secondary " onclick="location='${rc.contextPath}/card/editCardInfo.html?cardId=$!{card.cardId}'"><span class="am-icon-pencil-square-o"></span> 编辑</button>
                    #end
                    #if($!{card.auditState}!=1)
                    <button type="button" class="am-btn am-btn-default am-btn-xs am-text-secondary am-disabled" onclick="location='${rc.contextPath}/card/editCardInfo.html?cardId=$!{card.cardId}'"><span class="am-icon-pencil-square-o"></span> 编辑</button>
					#end
<!--                     <button type="button" id="$!{card.cardId}1" name="publishBtn" class="am-btn am-btn-default am-btn-xs am-text-warning" onclick="javascript:submitAuditTask('$!{card.cardId}')"><span class="am-icon-pencil-square-o"></span>提交审核</button> -->
                    
                    <button type="button" class="am-btn am-btn-default am-btn-xs am-text-danger am-hide-sm-only" onclick="javascript:deleteItem('$!{card.cardId}')""><span class="am-icon-trash-o"></span> 删除</button>
                  </div>
                </div>
              </td>
            </tr>
            #end
          </tbody>
        </table>
          <div class="am-cf">
  共 ${page.totalCount} 条记录
  <div class="am-fr">
    <ul class="am-pagination">
      <li #if(${page.pageNo}=='1') class="am-disabled" #end><a href="javascript:query(1)">«</a></li>
      #if(${page.totalPages}>0)
      #foreach($foo in [1..${page.totalPages}])
      <li #if($foo==$page.pageNo) class="am-active" #end><a href="javascript:query($foo)">$foo</a></li>
      #end
      #else
      <li class="am-active"><a href="javascript:query(1)">1</a></li>
      #end
      
      <li #if(${page.pageNo}==${page.totalPages}) class="am-disabled" #end><a href="javascript:query(${page.totalPages})">»</a></li>
    </ul>
  </div>
</div>
          <hr />
          <p>注：.....</p>
        </form>
      </div>

    </div>
  </div>
 </div>
 #admin_sidebar_sm
 #confirm
 #admin_footer
 <div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">导入结果
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
      $!{message}
    </div>
  </div>
</div>
<script type="text/javascript">
 $(document).ready(function() {
		var message = "$!{message}";
		if(message){
			$("#doc-modal-1").modal();
		}
	});
 
$(function(){
	
	//导入 start
	$('#incFile').on('change', function() {  
		$("#searchForm").attr('action','${rc.contextPath}/card/incCardInfo.html');
		$("#searchForm").submit();
	});
    //end
	
	$("#addBtn").click(function(){
		window.location.href='${rc.contextPath}/card/addCardInfo.html';
	});
	$("#submitAuditBtn").click(function(){
		submitAuditTask();
	});
	$("#searchBtn").click(function(){		
		query();
	});
});


function query(pageNo){
	if(pageNo){
		$("#pageNo").val(pageNo);
	}
	$("#searchForm").submit();
	
}

function deleteItem(cardId){
	if(cardId){
		$('#my-confirm').modal({
	        relatedTarget: this,
	        onConfirm: function(options) {
	          window.location.href='${rc.contextPath}/card/deleteCardInfo.html?cardId='+cardId;
	        },
	        // closeOnConfirm: false,
	        onCancel: function() {

	        }
	      });
	}
}


function submitAuditTask(){
	if($("input[name='cardId']:checked").size()<1){
		alert("请选择要提交审核的条目");
		return false;
	}
	$.AMUI.progress.start();
	 var cardIdList = new Array(); 
	 $("input[name='cardId']:checked").each(function(){
		 cardIdList.push($(this).val());
	 });
	$.ajax({
		type : 'post',
        url : '${rc.contextPath}/card/ajax/submitAuditTask.json',
		data : {'cardIdList':cardIdList},
        dataType : 'json',  
        success : function(data){
			if(data.success){
				$.AMUI.progress.done();
				location.reload();
			}else{
				alert("操作失败！");
				$.AMUI.progress.remove();
			}
        },  
        error : function(data,textstatus){
			alert("操作失败！");
			$.AMUI.progress.remove();
        }  
    });
	
}


// function submitAuditTask(cardId){
// 	if(cardId){
// 		$.AMUI.progress.start();
// 		$btn=$("#"+cardId+"1");
// 		$.ajax({
// 			type : 'post',
// 	        url : '${rc.contextPath}/card/ajax/submitAuditTask.json',
// 			data : 'cardId='+cardId,
// 	        dataType : 'json',  
// 	        async : false,
// 	        success : function(data){
// 	        	if(!data.success){
// 	        	}
// 	        },  
// 	        error : function(data){
// 	        	alert("操作失败");
// 	        }  
// 	    });
//     	$.AMUI.progress.done();
// 	}
// }

</script>